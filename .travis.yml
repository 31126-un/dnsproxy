matrix:
  include:
    - language: go
      sudo: false

      os:
        - linux

      env:
        - GO111MODULE=on
        - GIMME_GO_VERSION=1.x

      go:
        - 1.x

      script:
        - go test -race -v -bench=. -coverprofile=coverage.txt -covermode=atomic ./...

      after_success:
        - bash <(curl -s https://codecov.io/bash)

    - language: android
      sudo: true

      android:
        components:
          - tools
          - platform-tools
          - tools
          - build-tools-26.0.2
          - android-26

      os:
        - linux

      env:
        - GO111MODULE=on
        - GIMME_GO_VERSION=1.x

      # Make sure Android NDK is installed
      before_install:
        - mkdir -p $ANDROID_HOME/licenses
        - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
        - echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_HOME/licenses/android-sdk-license

      install:
        - eval "$(curl -sL https://raw.githubusercontent.com/travis-ci/gimme/master/gimme | bash)"
        - echo y | sdkmanager "ndk-bundle"
        - echo y | sdkmanager "cmake;3.6.4111459"
        - echo y | sdkmanager "lldb;3.1"

      script:
        - go version
        - cd mobile
        - make
        - zip -9 -r dnsproxy-android-library-${TRAVIS_TAG:-dev}.zip
        - ls -l dnsproxy-*

      deploy:
        provider: releases
        api_key: $GITHUB_TOKEN
        file:
          - dnsproxy-android-library-*.zip
        file_glob: true
        skip_cleanup: true
        draft: true